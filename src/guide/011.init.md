# アカウント作成とSSH環境構築

これをしないと始まらない。  



## アカウント作成

外部で操作する用のアカウントを作成する。  
初期ユーザーだけで使ってもいいが、設定をミスったときや `xrdp` を使用した際に同時ログインができないといった
障壁にぶつかりかねないので、2つあったほうが後々便利な気がする。

参考: [Ubuntu 20\.04 : 初期設定 インストールと設定 : Server World](https://www.server-world.info/query?os=Ubuntu_20.04&p=initial_conf)  

```bash
# グループ確認
$ sudo visudo
=> nano の閉じ方は Ctrl Shift X
=> vim の閉じ方は esc => :q

# アカウント作成
$ sudo adduser <ユーザー名>
=> パスワードを入力
=> 追加情報は入力の必要無し

# アカウントで sudo を使えるようにする
$ sudo usermod -G sudo <ユーザー名>

# ログインしてみて管理者のみの visudo を実行してみる
$ sudo login
=> <ユーザー名>入力
$ sudo visudo
```

記憶だと `wheel` ってグループだと思ってたけど、これは CentOS 仕様らしい。  
ちなみに big wheel (大物) が語源らしい。  
`sudo` のほうが分かりやすいよね。  

参考: [wheel \- セキュリティ](https://kaworu.jpn.org/security/wheel)  

また `visudo` を見てみると `admin` と `sudo` というグループがあった。  
この `admin` は後方互換性で残っているらしく、 Ubuntu 12.04LTS 以降は無視でOK。  

```bash
# visudo
# User privilege specification
root    ALL=(ALL:ALL) ALL

# Members of the admin group may gain root privileges
%admin ALL=(ALL) ALL

# Allow members of group sudo to execute any command
%sudo   ALL=(ALL:ALL) ALL
```

参考: [permissions \- What is the difference between the 'sudo' and 'admin' group? \- Ask Ubuntu](https://askubuntu.com/questions/43317/what-is-the-difference-between-the-sudo-and-admin-group)  



## ssh 接続の設定

linux の使用目的の大半は `ssh` 。  
母艦から操作できるようにしたほうが楽なので使えるようにする。  

参考: [Ubuntu 20\.04 : SSH サーバー インストールと設定 : Server World](https://www.server-world.info/query?os=Ubuntu_20.04&p=ssh)  

```bash
# インスコ
$ sudo apt install openssh-server

# （一応）設定のコピー
$ sudo cp /etc/ssh/sshd_config /etc/ssh/sshd_config.copy

# 編集
$ sudo vim /etc/ssh/sshd_config

# 設定を適用するための再起動
$ sudo systemctl restart sshd
```

`sshd_config` の編集箇所は下の通り。  
設定はお好みで。  

- Port をデフォルトのものから移動 (Port)
- 特定のユーザーのみログインOKに (AllowUsers)
- root でのログインを禁止に (PermitRootLogin)
- 鍵認証を明示的に許可 (PubkeyAuthentication)
- パスワード認証を禁止に (PasswordAuthentication)
  - 192.168.1.* からのアクセス時だけパスワード認証OK

```diff
$ diff -U 0 sshd_config.copy sshd_config
--- sshd_config.copy    2021-10-20 18:14:48.462826795 +0900
+++ sshd_config 2021-10-20 18:49:11.533569734 +0900
@@ -15 +15 @@
-#Port 22
+Port <ポート番号>
@@ -18,0 +19 @@
+AllowUsers <ユーザー名>
@@ -34 +35 @@
-#PermitRootLogin prohibit-password
+PermitRootLogin no
@@ -39 +40 @@
-#PubkeyAuthentication yes
+PubkeyAuthentication yes
@@ -58 +59 @@
-#PasswordAuthentication yes
+PasswordAuthentication no
@@ -123,0 +125,2 @@
+Match Address 192.168.1.*
+  PasswordAuthentication yes
```

参考: [外からは公開鍵、内側だけはパスワード許可 \- sshd の ローカル側だけパスワードを使えるようにする。 \- それマグで！](https://takuya-1st.hatenablog.jp/entry/20091022/1256236902)  
参考: [CentOS7 SSH設定の記録 \- Qiita](https://qiita.com/mirai_is_here/items/0120d584dd0c5ea0664d)  


ローカルネットワークではパスワード認証、外部ネットワークでは鍵認証という形にした。  
ローカルでは任意のPCからアクセスしたい可能性が想定されるので。  
鍵設定はまた今度。（直近で使う予定がない）  

てか `Match` 便利だねぇ... 複雑なこともなんでもできそう。  
個人的には鍵なら全てのユーザーにログイン可能、ってことをやりたかったんだけど、Matchにその構文が無かった...。  

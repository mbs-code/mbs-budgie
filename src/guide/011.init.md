# 最初にやること

## update / editor

これをしないと始まらない。  

参考: [Ubuntu のアップデート方法 \- Qiita](https://qiita.com/masoo/items/8ebc51a6a9f32417d4a3)  

```bash
# アップデート確認
$ sudo apt update

# パッケージをアップデートする
$ sudo apt dist-upgrade

# アップデートで必要なくなったパッケージの削除
$ sudo apt autoremove


# エディタのインストール
$ sudo apt install vim
```

私の宗派は `Vim` なのでついでにインストール。  
（どうせ設定編集でしか使わないし...矢印つかえるし...）  



## アカウント作成

外部で操作する用のアカウントを作成する。  
初期ユーザーだけで使ってもいいが、設定をミスったときや `xrdp` を使用した際に同時ログインができないといった
障壁にぶつかりかねないので、2つあったほうが後々便利な気がする。

参考: [Ubuntu 20\.04 : 初期設定 インストールと設定 : Server World](https://www.server-world.info/query?os=Ubuntu_20.04&p=initial_conf)  

```bash
# グループ確認
$ sudo visudo
=> nano の閉じ方は Ctrl Shift X
=> vim の閉じ方は esc => :q

# アカウント作成
$ sudo adduser <ユーザー名>
=> パスワードを入力
=> 追加情報は入力の必要無し

# アカウントで sudo を使えるようにする
$ sudo usermod -G sudo <ユーザー名>

# ログインしてみて管理者のみの visudo を実行してみる
$ sudo login
=> <ユーザー名>入力
$ sudo visudo
```

::: tip
記憶だと `wheel` ってグループだと思ってたけど、これは CentOS 仕様らしい。  
ちなみに big wheel (大物) が語源らしい。  
`sudo` のほうが分かりやすいよね。  

参考: [wheel \- セキュリティ](https://kaworu.jpn.org/security/wheel)  

また `visudo` を見てみると `admin` と `sudo` というグループがあった。  
この `admin` は後方互換性で残っているらしく、 Ubuntu 12.04LTS 以降は無視でOK。  

```bash
# visudo
# User privilege specification
root    ALL=(ALL:ALL) ALL

# Members of the admin group may gain root privileges
%admin ALL=(ALL) ALL

# Allow members of group sudo to execute any command
%sudo   ALL=(ALL:ALL) ALL
```

参考: [permissions \- What is the difference between the 'sudo' and 'admin' group? \- Ask Ubuntu](https://askubuntu.com/questions/43317/what-is-the-difference-between-the-sudo-and-admin-group)  

ちなみにこれの読み方は `<誰が> <どのホストで>=(<誰として>) <何ができるか>` という感じらしい。  
`%sudo   ALL=(ALL:ALL) ALL` を解読すると、

- %sudo: sudo というグループは
- ALL: どこでも
- (ALL:ALL): どのユーザーでも、どのグループでも
- ALL: なんでもできる

という要するに管理者って意味ですね。  
これはめっちゃ細く設定できるので、サーバーや制限ユーザー作成時にはちゃんと設定すべしな気がした。  

参考: [sudoers覚え書き \- Qiita](https://qiita.com/progrhyme/items/6f936033b9d23efb1741)  
:::



## SSH 接続の設定

linux の使用目的の大半は `ssh` 。  
母艦から操作できるようにしたほうが楽なので使えるようにする。  

参考: [Ubuntu 20\.04 : SSH サーバー インストールと設定 : Server World](https://www.server-world.info/query?os=Ubuntu_20.04&p=ssh)  

```bash
# インスコ
$ sudo apt install openssh-server

# （一応）設定のコピー
$ cd /etc/ssh
$ sudo cp sshd_config sshd_config.copy

# 編集
$ sudo vim sshd_config

# 設定を適用するための再起動
$ sudo systemctl restart sshd
```

`sshd_config` の編集箇所は下の通り。  
設定はお好みで。  

- Port をデフォルトのものから移動 (Port)
- 特定のユーザーのみログインOKに (AllowUsers)
- root でのログインを禁止に (PermitRootLogin)
- 鍵認証を明示的に許可 (PubkeyAuthentication)
- パスワード認証を禁止に (PasswordAuthentication)
  - 192.168.1.* からのアクセス時だけパスワード認証OK

```diff
$ diff -U 0 sshd_config.copy sshd_config
--- sshd_config.copy    2021-10-20 18:14:48.462826795 +0900
+++ sshd_config 2021-10-20 18:49:11.533569734 +0900
@@ -15 +15 @@
-#Port 22
+Port <ポート番号>
@@ -18,0 +19 @@
+AllowUsers <ユーザー名>
@@ -34 +35 @@
-#PermitRootLogin prohibit-password
+PermitRootLogin no
@@ -39 +40 @@
-#PubkeyAuthentication yes
+PubkeyAuthentication yes
@@ -58 +59 @@
-#PasswordAuthentication yes
+PasswordAuthentication no
@@ -123,0 +125,2 @@
+Match Address 192.168.1.*
+  PasswordAuthentication yes
```

参考: [外からは公開鍵、内側だけはパスワード許可 \- sshd の ローカル側だけパスワードを使えるようにする。 \- それマグで！](https://takuya-1st.hatenablog.jp/entry/20091022/1256236902)  
参考: [CentOS7 SSH設定の記録 \- Qiita](https://qiita.com/mirai_is_here/items/0120d584dd0c5ea0664d)  


ローカルネットワークではパスワード認証、外部ネットワークでは鍵認証という形にした。  
ローカルでは任意のPCからアクセスしたい可能性が想定されるので。  
鍵設定はまた今度。（直近で使う予定がない）  

てか `Match` 便利だねぇ... 複雑なこともなんでもできそう。  
個人的には鍵なら全てのユーザーにログイン可能、ってことをやりたかったんだけど、Matchにその構文が無かった...。  

::: tip
`/etc/ssh` に `ssh_config` と `sshd_config` という2つのファイルがあって、なにが違うのか気になったので調査した。  

- `ssh_config`: ssh で接続するときの設定
- `sshd_config`: ssh で接続されるときの設定

あーなるほど。  
ssh コマンドもこのパッケージの一部なのね。  

参考: [sshとsshdの違い \- Qiita](https://qiita.com/pocket8137/items/e504fa2481d5b9f0c064)  
:::



## SSH 接続を行う

母艦、別のPCから以下のコマンドで SSH 接続できる。  

```bash
$ ssh <ユーザー名>@<アドレス> -p <ポート番号>
=> パスワード入力
```

これができたら後はリモートで作業しても良い。  
PCはログアウトして放置しておこう。  

:::warning
```bash
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@    WARNING: REMOTE HOST IDENTIFICATION HAS CHANGED!     @
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
```

これは前回のアクセス時と環境が違うよ！という警告です。  
ホストの公開鍵が違うので中間者攻撃されているかもよ、という親切心の塊です。  
焦らず対象のホストの記録をローカルから消しましょう。  

```bash
$ ssh-keygen -R <アドレス>
```

（はじめサーバー側のエラーかと思って、設定ファイルとにらめっこしていたのは内緒。）  
（英語は Google 翻訳にかけてでも読もう。）  

参考: [「SSHホスト鍵が変わってるよ！」と怒られたときの対処 \- Qiita](https://qiita.com/hnw/items/0eeee62ce403b8d6a23c)  
:::



## XRDP 接続の設定

簡単に言うとリモートデスクトップ。  
Linux 系には VNC っていうリモート操作用の仕組みが備わっているが、それとは違ってリモートで直接ログインする感じ。  
VNC はログイン中のユーザーを操作する仕組み。  
逆に GUI でログイン中のユーザーに対しては接続できない。  

VNC  が google のリモートデスクトップ  
XRDP が windows のリモートデスクトップ、という認識が近い。  

それもあってかとても軽量で、セキュリティ性も高いのでおすすめ。  

```bash
# インスコ
$ sudo apt install xrdp

# （一応）設定のコピー
$ cd /etc/xrdp
$ sudo cp startwm.sh startwm.sh.copy

# 編集
$ sudo vim startwm.sh

# 設定を適用するための再起動
$ sudo systemctl restart xrdp
```

`sshd_config` の編集箇所は下の通り。  
起動時に budgie desktop を起動するようにする。  

```diff
$ diff -U 0 startwm.sh.copy startwm.sh
--- startwm.sh.copy     2021-10-21 00:34:14.996716937 +0900
+++ startwm.sh  2021-10-21 00:34:35.852593748 +0900
@@ -33 +33 @@
-test -x /etc/X11/Xsession && exec /etc/X11/Xsession
+test -x /etc/X11/Xsession && exec /etc/X11/Xsession /usr/bin/budgie-desktop
```

参考: [Remote Desktop and Ubuntu Budgie 19.04](http://www.novofirmus.com/2020/07/27/remote-desktop-and-ubuntu-budgie-19-04/)



## RDP 接続を行う

Windows の場合、 `リモート デスクトップ接続` アプリを実行する。  


<img :src="$withBase('/assets/win-remote-02.png')" height="240px">  
<img :src="$withBase('/assets/win-remote-03.png')" height="240px">  

`login failed for display 0` ってでてきたらパスワードが違う系。  
他のエラーならそもそも接続できないと思われ。  


:::warning
日本語の windows から接続するとほぼ 100% で JIS キーボードと認識されます。  
キーボードレイアウトを USKEY にしていても無駄です。；；  

色々対処法があるようですが、接続時に IME を英語にするやり方がシンプルで楽でした。  
RDP は接続時に環境の言語情報を送るので、英語にしておくと入力を US キーボードとして認識してくれます。  
**接続時だけでOK** です。  

<img :src="$withBase('/assets/xrdp-01.png')" height="240px">  
<img :src="$withBase('/assets/xrdp-02.png')" height="240px">  

Windows 10 デフォルトの切り替えショートカットは `Alt + Ctrl` です。  

（これで2日は持ってかれた！！！！！）

参考: [xrdpでクライアントのキーボード種別を認識させる方法](https://tamapoco.com/archives/6260)  
参考: [XRDP で macOS から Ubuntu に接続したときにキーボードを US 配列で認識させる](https://ez-net.jp/article/36/iuQFADZB/cpjF6tqaBv7b/)  

参考: [Windows 10 Alt \+ Shift で IME の入力言語の切り替えを無効にする](https://www.tipsfound.com/windows10/12008)  
:::



## 日本語入力

fcitx + mozc という構成が王道らしい。  
mozc は要するにフリーの google 日本語入力らしい。  
で fcitx が IME を切り替えてくれるやつ？（情報不足）  

がこの fcitx が **めーちゃんこ落ちる**。Budgie と相性悪いのかな...？  
落ちたら `Ctrl + Alt + F3〜F6` を押して `restart display-manager` だ。  


まず「言語サポート」というアプリを起動して、`キーボード入力に使うIMシステム` を `fcitx` にする。  
でログアウト => ログイン。  

<img :src="$withBase('/assets/ime-01.png')" height="240px">  

次に「Fcitx 設定」というアプリを起動して設定していく。  
まず「入力メソッド」タブで `US` => `Mozc` の順番で並んでいることを確認する。  
（並んでいなかったら `IMシステム` の設定が悪いかも）  

次に「全体の設定」で「Show Advanced Option」にチェックを入れる。  
入力メソッドのオンオフに `Ctrl + Space` と `Alt + \` を入れる。これは緊急用だ。  
そして左右の `Alt` 空打ちで IME を切り替えられるように、入力オンを `Ralt` 入力オフを `Lalt` にする。  
再起動して完成だ。  

<img :src="$withBase('/assets/ime-02.png')" height="240px">  
<img :src="$withBase('/assets/ime-03.png')" height="240px">  

参考: [Ubuntu Budgie 19\.04 その4 \- Fcitx \+ Mozcで日本語入力するには \- kledgeb](https://kledgeb.blogspot.com/2019/04/ubuntu-budgie-1904-4-fcitx-mozc.html)  
参考: [Ubuntu 18\.04 \+ US キーボードで日本語入力環境を整える \- Neo's World](https://neos21.net/blog/2020/03/20-02.html)  

::: tip
mozc のアイコンが大きすぎてバーからはみ出る問題。  
デフォルトでは 32x32 なのでこれを 22x22 くらいにする。  

せっかく linux 使ってるんだからプログラムで縮小するぞ～。  

```bash
# imagemagick の導入
$ sudo apt install imagemagick

# バックアップ作成
$ sudo cd /usr/share/icons/mozc
$ sudo cp ime_product_icon_opensource-32.png ime_product_icon_opensource-32.png.copy

# 変換する
$ sudo convert -resize 22x22 ime_product_icon_opensource-32.png out.png

# 置き換える
$ sudo rm ime_product_icon_opensource-32.png
$ sudo mv out.png ime_product_icon_opensource-32.png

```

本当は `-22.png` とかにすればいいんだろうけど、シンボリックリンクが貼ってあって
面倒だからそのままで対処した。  
これでバーにぴったし収まった。  

参考: [Linux Beginner: elementary OS 0\.3\.2 Freya の Mozc のアイコンを小さくする方法](https://linuxbeginnerblog.blogspot.com/2016/12/elementary-os-032-freya-mozc.html)  
参考: [imagemagickで画像のリサイズ \- Qiita](https://qiita.com/tukiyo3/items/ba5aa7c89e1ca2c50542)  
:::
